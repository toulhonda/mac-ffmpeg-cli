# 詳細設計書 (design.md) - v2.0

## 1. 全体構成

本CLIは、単一のBashスクリプト (`mac-ffmpeg.sh`) として実装する。メインループでユーザーからの入力を受け付け、選択されたオプションに応じて対応する関数を呼び出す構造とする。

```
mac-ffmpeg.sh
├── display_splash()      # 起動ロゴの表示
├── display_menu()        # 操作メニューの表示と入力受付
├── handle_brew_update()  # Homebrewアップデート処理
├── handle_single_file_conversion() # 単一ファイル変換処理
├── handle_directory_conversion()   # ディレクトリ一括変換処理
└── run_ffmpeg_command()  # FFmpegコマンドの実行
```

## 2. 関数設計

### 2.1. `main()` 関数

  * CLIのメインループを管理する。
  * `display_splash()` を初回に呼び出す。
  * ループ内で `display_menu()` を呼び出してメニューを表示し、ユーザーの選択を受け付ける。
  * `case` 文を使い、ユーザーの選択に応じて適切なハンドラ関数を呼び出す。
  * `4. 終了` が選択された場合は、`exit 0` でスクリプトを終了する。

### 2.2. `display_splash()` 関数

  * **機能**: スクリプトに埋め込まれたアスキーアートのロゴを `cat <<'EOF'` を用いて表示する。
  * **処理**: ロゴを表示した後、`sleep 2` で2秒間待機する。

### 2.3. `display_menu()` 関数

  * **機能**: ユーザーに選択肢を表示し、入力を待つ。
  * **処理**: `echo` でメニュー項目を表示し、`read -p` でユーザーの入力を変数 `choice` に格納する。
  * **戻り値**: `return $choice` で選択された番号を返す。

### 2.4. `handle_brew_update()` 関数

  * **機能**: Homebrew のアップデートを実行し、結果を表示する。
  * **処理フロー**:
    1. `command -v brew` で `brew` コマンドの存在を確認。なければエラー表示。
    2. `brew update && brew upgrade` を実行。
    3. 終了コード (`$?`) を確認し、成功または失敗のメッセージを表示。

### 2.5. `run_ffmpeg_command(input_file_path)` 関数

  * **機能**: FFmpeg コマンドを実行し、音声ファイルをMP4に変換する。
  * **引数**: `input_file_path` (変換対象のファイルパス)
  * **処理フロー**:
    1. `command -v ffmpeg` で `ffmpeg` コマンドの存在を確認。
    2. 入力パスから出力パス (`.mp4`) を生成。
    3. **進捗表示のため `-v quiet -stats` オプションを付けて** FFmpeg コマンドを実行。
        ```bash
        ffmpeg -y -f lavfi -i color=black:s=1280x720:r=25 -i "$input_file" -shortest -c:v libx264 -c:a aac -b:a 192k -pix_fmt yuv420p -v quiet -stats "$output_file"
        ```
    4. 終了コード (`$?`) を確認し、成功時は `0`、失敗時は `1` を返す。

### 2.6. `handle_single_file_conversion()` 関数

  * **機能**: 個別の音声ファイルをMP4に変換する。
  * **処理フロー**:
    1. `read -p` で変換対象のファイルパスをユーザーから受け取る。
    2. パスの存在を `[ ! -f "$path" ]` でチェック。
    3. ファイルの拡張子をチェックし、`.wav`, `.mp3`, `.m4a`, `.wma` 以外はエラー表示。
    4. `run_ffmpeg_command()` を呼び出して変換を実行し、結果を表示。

### 2.7. `handle_directory_conversion()` 関数

  * **機能**: 指定ディレクトリ内の音声ファイルを一括変換する。
  * **処理フロー**:
    1. `read -p` で対象のディレクトリパスをユーザーから受け取る。
    2. パスの存在を `[ ! -d "$path" ]` でチェック。
    3. `find` コマンドでディレクトリ内の対象音声ファイル (`.wav`, `.mp3`, `.m4a`, `.wma`) を検索し、配列に格納。
    4. 対象ファイル数を表示。
    5. `for` ループで各ファイルを処理。`run_ffmpeg_command()` を呼び出し、成功/失敗カウントを更新。
    6. ループの各サイクルで進捗 (`X/Y件`) を表示。
    7. 全件処理後、最終的な成功/失敗件数を表示。

## 3. エラーハンドリング

  * **コマンド存在チェック**: `command -v` を使用して `brew` と `ffmpeg` の有無を確認する。
  * **ファイル/ディレクトリ存在チェック**: `[ -f ... ]` および `[ -d ... ]` でパスの有効性を確認する。
  * **FFmpeg実行結果**: `subprocess.run()` の終了コード (`$?`) を確認し、結果に応じてメッセージを分岐させる。

## 4. UIテキスト (日本語)

スクリプト内にハードコードされた日本語メッセージを使用する。

  * `指定されたファイルが見つかりません。再入力してください。`
  * `対応していないファイル形式です。WAV, MP3, M4A ファイルのみ対応しています。`
  * `ファイルの変換が成功しました: {出力ファイル名}`
  * `ファイルの変換に失敗しました: {入力ファイル名}`
  * `変換が完了しました。成功: {成功数}件, 失敗: {失敗数}件`
  * `({current_file_index}/{total_files}) ファイルを変換中: ...`
  * `Homebrew のアップデートが完了しました。`